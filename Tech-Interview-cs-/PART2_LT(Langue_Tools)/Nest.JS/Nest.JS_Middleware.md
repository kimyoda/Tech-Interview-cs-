# 🌐 NestJS 미들웨어

## 1.미들에워란?

### 1-1. 개념

- 미들웨어는 **요청(Request)와 응답(Response)사이에 동작하는 중간 처리 계층이다**.
- 요청이 최종 목적지(Controller)에 도달하기 전에 여러 단계의 검사와 처리를 거치게 된다.

### 1-2. 필요한 이유

1. 관심사의 분리

   - 인증, 로깅, 데이터 검증 등을 비즈니스 로직과 분리한다.
   - 코드 재사용성이 향상된다.

2. 일관성 있는 처리

   - 모든 요청에 대해 동일한 규칙을 적응한다.
   - 보안, 에러 처리 등을 표준화한다.

3. 유지보수성
   - 공통 기능을 한곳에서 관리한다.
   - 변경 사항을 쉽게 적용한다.

---

## 2. 🔄 미들웨어 실행 순서 이해하기

```bash
요청 -> Middleware -> Guard -> Interceptor(Before) -> Pipe -> Controller -> Service -> Controller -> Interceptor(After) -> Filter -> 응답
```

- NestJS는 정해진 아키텍처 패턴(모듈, 컨트롤러, 서비스)를 제공하고 TypeScript 기반으로 타입 안전성과 의존성 주입을 지원해 규모가 큰 애플리케이션 개발에 적합하다.

회사 출입 과정 비유 흐름 과정

1. Middleware : 모든 방문자에 대한 체크를 한다.
2. Guard: 직원인지, 외부인 인지 확인한다.
3. Interceptor: 입장 시간을 기록한다.
4. Pipe: 방문 목적에 맞는 명찰을 부여한다.
5. Controller: 어디로 가야하는 지 안내한다.
6. Service: 미팅, 작업 등을 수행하는 역할
7. Interceptor After: 퇴장 시간을 기록한다.
8. Filter: 분실물 및 사고를 처리한다.

---

## 1_1. Guards(가드)

### 핵심 개념

- 누가 들어올 수 있는가 를 결정하는 보안 담당자

1. 인증 (Authentication) - 인증된 사람만

   - 로그인이 필요한 모든 API
   - 마이페이지, 장바구니, 주문내역 등

2. 인가 (Authorization) - 권한이 있는가
   - 관리자 페이지
   - 회원 관리, 통계 대시보드

-> 비로그인은 홈페이지만, 기본 회원은 일반 화질, 프리미엄 이용자는 다중 기기 동시 시청도 가능, 비 로그인은 상품 겅색 및 조회 / 로그인은 장바구니 및 구매만

---

## 1_2. Pipe(파이프)

### 핵심 개념

- 데이터가 올바른지 검증하고 변환하는 과정이다.

1. 데이터를 검증할 때

   - 이메일 형식이 맞는지? 비밀번호가 8자 이상인지?
   - 필수 항목이 모두 입력 되었는지?

2. 데이터 변환
   - 문자열 "123" -> 숫자 123으로 변환, 날짜 문자열 -> Date 객체, JSON -> 객체

---

## 1_3. Interceptors(인터셉터), 관찰

### 핵심 개념

요청 / 응답 전후에 무엇을 할까를 담당하는 담당자이다.

1. 로깅

   - API 호출 추적
   - 성능 모니터링, 디버깅 정보를 수집한다.

2. 응답변환 (Transform)

```ts
// 원본 응답
{ id: 1, name: "John" }

// 변환 후
{
  success: true,
  data: { id: 1, name: "John" },
  timestamp: "2025-01-15T10:30:26.000Z"
}
```

3. 캐싱

```bash
첫 요청: DB 조회 → 500ms
캐시 저장
두 번째 요청: 캐시에서 가져옴 → 5ms
```

---

## 1_4. Filters(필터)

### 핵심 개념

- 문제가 생기면 어떻게 처리할지에 관한 업머

1. 에러 종류별 처리

```bash
404 Not Found: "요청하신 페이지를 찾을 수 없습니다"
401 Unauthorized: "로그인이 필요합니다"
403 Forbidden: "접근 권한이 없습니다"
500 Internal Error: "일시적인 오류가 발생했습니다"
```

1. 에러 로깅
   - 어떤 에러가 발생했는지 기록한다.
   - 언제, 어디서, 누가 에러를 겪었는지 추적한다.
   - 알림 전송

---

## 2. 커스텀 데코레이터

### 핵심 개념

- 반복되는 코드를 간단하게 만드는 도구이다.

---
